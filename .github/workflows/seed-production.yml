name: Database Update & Seed

on:
  workflow_dispatch:
    inputs:
      seed_type:
        description: "Type of seed to run"
        required: true
        default: "yaml"
        type: choice
        options:
          - "yaml"
          - "engagement"
          - "none"
      force_migrate:
        description: "Force migration even if not needed"
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  update-database:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Prisma generate
        run: pnpm prisma generate

      - name: Check migration status
        id: check_migration
        run: |
          echo "üîç Checking if migrations are needed..."

          # Set connection timeout and statement timeout
          export PGCONNECT_TIMEOUT=15
          export PGSTATEMENT_TIMEOUT=45000

          # Try to check migration status with timeout
          if timeout 30s pnpm prisma migrate status 2>&1 | tee migration_status.txt; then
            if grep -q "Database schema is up to date" migration_status.txt; then
              echo "status=up-to-date" >> $GITHUB_OUTPUT
              echo "‚úÖ Database is up to date"
            else
              echo "status=needs-migration" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Migrations needed"
            fi
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Could not determine migration status (timeout or error)"
          fi

          rm -f migration_status.txt
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: true

      - name: Resolve failed migrations
        if: ${{ steps.check_migration.outputs.status == 'needs-migration' || steps.check_migration.outputs.status == 'unknown' || inputs.force_migrate == 'true' }}
        run: |
          echo "üîç Checking for failed migrations..."

          # Check if there are any failed migrations
          if pnpm prisma migrate status 2>&1 | grep -q "migrate found failed migrations"; then
            echo "‚ö†Ô∏è  Found failed migrations - attempting to resolve..."
            pnpm tsx scripts/resolve-failed-migration.ts || echo "Note: Could not auto-resolve failed migrations"
          else
            echo "‚úÖ No failed migrations found"
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        continue-on-error: true

      - name: Run migrations with retry
        if: ${{ steps.check_migration.outputs.status == 'needs-migration' || steps.check_migration.outputs.status == 'unknown' || inputs.force_migrate == 'true' }}
        run: |
          echo "üîÑ Running database migrations with retry logic..."

          # Function to run migration with timeout
          run_migration() {
            local attempt=$1
            echo "Attempt $attempt of 3..."
            
            # Set connection and statement timeouts
            export PRISMA_ENGINE_PROTOCOL=graphql
            export PGCONNECT_TIMEOUT=15
            export PGSTATEMENT_TIMEOUT=45000
            
            # Try migration with timeout
            if timeout 60s pnpm prisma migrate deploy; then
              echo "‚úÖ Migration successful"
              return 0
            else
              echo "‚ùå Migration failed or timed out"
              return 1
            fi
          }

          # Retry logic
          max_attempts=3
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            if run_migration $attempt; then
              echo "migration_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚è≥ Waiting 10 seconds before retry..."
              sleep 10
            fi
            
            attempt=$((attempt + 1))
          done

          echo "‚ùå All migration attempts failed"
          echo "migration_status=failed" >> $GITHUB_OUTPUT

          # If migration fails, check if it's due to already being applied
          if pnpm prisma migrate status 2>&1 | grep -q "Database schema is up to date"; then
            echo "‚úÖ Database is actually up to date (migrations already applied)"
            echo "migration_status=already-applied" >> $GITHUB_OUTPUT
            exit 0
          fi

          exit 1
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run YAML seed
        if: ${{ inputs.seed_type == 'yaml' && (success() || steps.check_migration.outputs.status == 'up-to-date') }}
        run: |
          echo "üå± Running YAML-based seed..."
          pnpm run db:seed-yaml
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run engagement seed
        if: ${{ inputs.seed_type == 'engagement' && (success() || steps.check_migration.outputs.status == 'up-to-date') }}
        run: |
          echo "üå± Running engagement seed..."
          pnpm run seed:engagement
        env:
          NODE_ENV: production
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Summary
        if: always()
        run: |
          echo "üìä Workflow Summary"
          echo "===================="
          echo "Migration status: ${{ steps.check_migration.outputs.status }}"
          echo "Seed type: ${{ inputs.seed_type }}"
          echo ""

          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Database update completed successfully"
          else
            echo "‚ùå Database update failed"
            echo ""
            echo "üí° Troubleshooting tips:"
            echo "  - Check if DATABASE_URL secret is correctly set"
            echo "  - Verify database is accessible and not under heavy load"
            echo "  - Check if another migration process is running"
            echo "  - Consider running with force_migrate: true"
          fi
